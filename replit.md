# Gestor de Tareas Accesible

## Overview
Aplicación de gestión de tareas con enfoque en accesibilidad natural mediante HTML semántico. Diseñada para ser completamente accesible con lectores de pantalla y navegación por teclado, sin uso excesivo de ARIA.

## Recent Changes
- **2025-11-11 (tarde)**: Corrección de accesibilidad en campos de texto para lectores de pantalla
  - **Problema**: Los campos de texto (Input/Textarea) no permitían lectura fluida por caracteres con NVDA/VoiceOver
  - **Causa raíz**: Hooks de atajos de teclado globales interceptaban teclas antes de verificar si estábamos en campos editables
  - **Solución principal**: Modificado useKeyboardShortcuts para verificar campos editables PRIMERO, antes de cualquier preventDefault()
    - Usa document.activeElement para detectar si hay un campo de texto enfocado
    - Verifica INPUT, TEXTAREA, contenteditable
    - TODOS los atajos se ignoran completamente cuando se está escribiendo
  - **Solución adicional en sidebar**: Añadida verificación de campos editables al listener Cmd/Ctrl+B
  - **Solución secundaria**: Limpiado FormControl para solo incluir aria-describedby cuando hay mensajes de error
  - **Resultado**: Lectura por caracteres ahora funciona correctamente con lectores de pantalla
  - **Nota técnica**: Los atajos de teclado nunca deben interceptar eventos dentro de INPUT, TEXTAREA o elementos contenteditable
- **2025-11-11 (mañana)**: Descripciones de listas con soporte Markdown
  - **Campo description**: Añadido campo nullable `description` a tabla lists
  - **Textarea multilínea**: Formularios de creación y edición usan Textarea para descripción
    - Placeholder con ejemplo de sintaxis Markdown
    - Soporte completo para Markdown (encabezados, listas, enlaces, negrita, cursiva)
  - **Renderizado Markdown**: Componente ViewListDescriptionDialog
    - Usa react-markdown para renderizado seguro (sin rehypeRaw para prevenir XSS)
    - Estilos prose con scroll automático
    - Modal accesible con Radix Dialog
  - **Botones en sidebar**:
    - Botón "Ver descripción [nombre lista]" (icono Eye) cuando lista tiene descripción
    - Botón "Editar [nombre lista]" (icono Pencil) para todas las listas
    - aria-labels descriptivos, data-testid para testing
  - **EditListDialog**: Nuevo componente para editar listas
    - Similar a AddListDialog pero con reset de formulario vía useEffect
    - Permite editar nombre, color y descripción
  - **Pattern de registration callback**: 
    - Home.tsx registra handler de edición con App.tsx vía useCallback + useEffect
    - Handler envuelto en arrow function al registrarse: `() => handleEditList` (necesario porque setState trata funciones de forma especial)
    - Cleanup correcto registrando `() => null` en unmount para prevenir callbacks obsoletos
    - App.tsx almacena handler en useState y lo propaga a AppSidebar
    - AppSidebar renderiza botón editar solo cuando handler existe
    - Previene setState sobre componentes desmontados
  - **Normalización backend**: 
    - POST/PATCH /api/lists convierten descripciones vacías a undefined
    - Drizzle ORM convierte undefined a NULL en base de datos
  - **Accesibilidad**: Todos los nuevos componentes siguen patrones accesibles con Radix UI
- **2025-11-10 (tarde)**: Checkbox "sin fecha" y ordenamiento por fecha de vencimiento
  - **Checkbox "Añadir fecha de vencimiento"**: Nuevo checkbox que controla la visibilidad de todos los selectores de fecha/hora
    - Similar al checkbox "Añadir hora específica" existente
    - Cuando está desmarcado: no se muestran selectores y dueDate = null
    - Cuando está marcado: se muestran selectores de día, mes, año
    - Totalmente accesible con lectores de pantalla
  - **Ordenamiento automático de tareas**: Las tareas ahora se ordenan automáticamente
    - Tareas con fecha de vencimiento primero, ordenadas por fecha/hora ascendente (las más próximas primero)
    - Tareas sin fecha al final
    - El ordenamiento considera tanto la fecha como la hora (usando getTime())
    - Implementación eficiente sin mutación del array original
- **2025-11-10 (mañana)**: Sistema de notificaciones eliminado
  - **Razón**: Web Notifications API es fundamentalmente poco confiable (iOS Safari no lo soporta excepto en PWAs, navegadores suspenden timers en pestañas inactivas)
  - **Eliminado**: Campo reminderMinutes, notificationService.ts, selectores de recordatorio, banner de permisos, columna de base de datos
  - **Solución futura**: Si se necesitan recordatorios, implementar sistema server-side con emails en lugar de Web Notifications API
  - **Selector de minutos mejorado**: Ahora muestra todos los valores de 0 a 59 (antes solo 0, 15, 30, 45) para mayor precisión
- **2025-11-09**: Refactorización mayor de fecha/hora, persistencia y notificaciones
  - **HTML semántico**: Corregido elemento `<main>` duplicado (SidebarInset ya usa `<main>`, App.tsx cambió a `<div>`)
  - **Persistencia con PostgreSQL**:
    - Migrado de almacenamiento en memoria (MemStorage) a base de datos PostgreSQL
    - Implementación con Drizzle ORM (@neondatabase/serverless)
    - Fallback automático a MemStorage si DATABASE_URL no está disponible
    - Datos persisten entre sesiones y dispositivos
  - **Selectores de fecha/hora accesibles** (estilo GOV.UK):
    - Componente `DateTimePicker` con selectores separados para día, mes (nombres localizados), año
    - Checkbox "Añadir fecha de vencimiento" para mostrar/ocultar todos los selectores de fecha
    - Checkbox "Añadir hora específica" que muestra selectores de hora (0-23) y minuto (0-59)
    - IDs únicos por instancia usando React `useId()` para evitar duplicados
    - Totalmente accesible con NVDA (Chrome/Windows) y VoiceOver (Safari/iPhone)
    - Eliminados inputs type="date" y type="time" problemáticos con lectores de pantalla
  - **Limpieza de código**:
    - Eliminadas importaciones innecesarias (X de lucide-react en add-task-dialog)
    - TypeScript types mejorados para evitar undefined en DateTimePicker
  - **Formato de fecha corregido**:
    - Función formatDueDate ahora detecta si la fecha tiene hora específica
    - Muestra "d de MMMM, HH:mm" cuando hay hora (ej: "15 de diciembre, 14:30")
    - Muestra solo "d de MMMM" cuando no hay hora (ej: "15 de diciembre")
- **2025-11-08 (tarde)**: Mejoras de accesibilidad en selectores de fecha/hora
  - **Campos separados**: Separación de datetime-local en dos inputs independientes para VoiceOver
    - Input type="date" etiquetado como "Fecha de vencimiento"
    - Input type="time" etiquetado como "Hora de vencimiento" (solo visible cuando hay fecha)
    - Mensaje explicativo: "Opcional. Si no especificas hora, será medianoche (00:00)"
  - **Implementación técnica**:
    - Valores derivados directamente de field.value (sin estado local desincronizado)
    - Formateo manual con getFullYear()/getMonth()+1/getDate() (sin conversión UTC)
    - Construcción de Date con new Date(year, month-1, day, hours, minutes) en zona horaria local
    - Garantiza sincronización correcta después de form.reset() y entre diferentes tareas
- **2025-11-08 (mañana)**: Refactorización mayor para mejorar accesibilidad y claridad
  - **Jerarquía de encabezados**:
    - h1 "Gestor de tareas" como encabezado principal en sidebar
    - h2 "Mis Tareas" en sidebar (navegable con H/Shift+H en NVDA)
    - h2 "Listas" en sidebar (navegable con H/Shift+H en NVDA)
    - Vista "Todas las tareas": h2 "Tareas pendientes" y h2 "Tareas completadas" en área principal
    - Vista filtrada o de lista: h2 contextual descriptivo en área principal
  - **Filtros en sidebar**:
    - Filtros movidos a sidebar bajo "Mis Tareas"
    - Tres botones: "Todas las tareas", "Pendientes", "Completadas"
    - Selector de filtros eliminado del header principal
  - **Correcciones para VoiceOver (iPhone)**:
    - Sidebar siempre visible (collapsible="none") en móvil y desktop para garantizar accesibilidad
    - Reemplazado confirm() nativo con AlertDialog de Radix UI para confirmación de eliminación
    - Eliminados aria-describedby innecesarios de DialogContent (mantenidos solo en formularios)
    - Selectores de fecha usan onBlur en lugar de onChange para evitar establecer fecha automáticamente al navegar
  - **Formularios modales**: 
    - Añadir tarea ahora es un diálogo modal (evita mezcla con tareas existentes)
    - Selector de lista integrado en formularios de crear/editar tarea (select nativo)
    - Asignación explícita de lista en lugar de automática por contexto
    - Modal de editar: eliminado botón "Cancelar" duplicado (DialogContent incluye botón X)
  - **Mejoras de accesibilidad**:
    - Toast notifications con región aria-live separada (solución a bug Radix UI #3634)
    - Región sr-only siempre presente para que NVDA la registre al cargar la página
    - Notificaciones descriptivas: "Tarea marcada como completada/pendiente" en lugar de mensaje genérico
    - aria-pressed en botones de filtro/lista (VoiceOver requiere aria-pressed en botones, no aria-current)
    - Grupos de botones con role="group" y aria-label descriptivo
    - Jerarquía de encabezados coherente en todas las vistas
    - Sidebar siempre visible (toggle eliminado por no ser útil para lectores de pantalla)
  - **Fechas de vencimiento**: Selector HTML5, indicadores visuales, manejo correcto de zona horaria
  - **Atajos de teclado**: N (nueva tarea), L (nueva lista), ? (ayuda), Escape (cerrar)
  - **Sistema de listas**: 
    - Listas puramente para filtrar vista (no auto-asignan tareas)
    - Selector "Asignar a lista" en formularios con opción "Sin lista"
    - Selectores nativos HTML en lugar de componentes custom
    - Botón de eliminar lista junto a cada lista en sidebar con confirmación

## Architecture

### Frontend
- React + TypeScript con Wouter para enrutamiento
- Shadcn UI para componentes accesibles por defecto
- TanStack Query para gestión de estado
- HTML semántico: `<main>`, `<nav>`, `<form>`, `<label>`, `<button>`
- Navegación completa por teclado (Tab, Enter, Escape)

### Backend
- Express.js con base de datos PostgreSQL
- Drizzle ORM para gestión de base de datos (@neondatabase/serverless)
- Fallback a MemStorage si DATABASE_URL no está disponible
- API RESTful para CRUD de tareas y listas
- Validación con Zod

### Data Model
- **Tasks**: id, title, description, completed, priority (0-3), listId, dueDate (timestamp)
- **Lists**: id, name, color, description (nullable text, Markdown)

## User Preferences
- **Accesibilidad**: Prioridad en HTML semántico, uso mínimo de ARIA
- **Diseño**: Limpio, eficiente, inspirado en Linear y Todoist
- **Navegación**: Completa por teclado sin mouse

## Key Features
- **Gestión de tareas**:
  - Crear tareas mediante diálogo modal con campos: título, descripción, lista, prioridad, fecha/hora
  - Editar y eliminar tareas existentes
  - Marcar tareas como completadas/pendientes
  - Sistema de prioridades (ninguna, baja, media, alta)
- **Listas personalizables**:
  - Crear listas con nombre, color y descripción Markdown opcional
  - Editar listas existentes (nombre, color, descripción)
  - Ver descripción renderizada en modal accesible
  - Eliminar listas (botón junto a cada lista en sidebar)
  - Filtrar vista por lista (sidebar)
  - Asignar tareas a listas explícitamente en formularios
  - Opción "Sin lista" disponible
- **Filtros y búsqueda**:
  - Filtros: Todas/Completadas/Pendientes
  - Búsqueda global en tiempo real por título y descripción
  - Encabezado descriptivo indica vista activa
- **Fechas de vencimiento**: 
  - Checkbox "Añadir fecha de vencimiento" para tareas sin fecha
  - Selectores segmentados accesibles (día, mes, año, hora, minuto)
  - Checkbox "Añadir hora específica" para añadir hora a una fecha
  - Indicadores visuales de estado (vencido, hoy, futuro)
  - Ordenamiento automático: tareas con fecha primero (más próximas arriba), sin fecha al final
  - Compatible con NVDA y VoiceOver
- **Atajos de teclado**: N (nueva tarea), L (nueva lista), ? (ayuda), Escape (cerrar)
- **Accesibilidad total**:
  - HTML semántico (h1, h2, nav, main, form, label), uso mínimo de ARIA
  - Navegación completa por teclado
  - aria-current en elementos activos
  - Notificaciones toast con región aria-live dedicada para NVDA
  - Mensajes descriptivos y contextuales en todas las acciones
  - Completamente accesible con lectores de pantalla
  - Probado con NVDA (Chrome/Windows) y VoiceOver (Safari/iPhone)
